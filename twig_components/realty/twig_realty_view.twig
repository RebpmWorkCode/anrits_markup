{{ html.script(['https://api-maps.yandex.ru/2.1/?lang=ru_RU', 'Agency.filter-map-site.js', 'YandexMaps.view-map.js'], {'inline': false}) }}
{% set adView = _view.loadHelper('Agency.AdView') %}
{% set adSeo = _view.loadHelper('Agency.AdSeo') %}
{% set favorite = _view.loadHelper('Favorites.Favorite') %}
{{ adView.setOgparh(advertisement) }}
{{ adSeo.imageSrcLink(advertisement) }}
{{ adView.setDefaults({default_picture: config.Site.no_photo_image}) }}
<section class="section-case-card" id="case-card">
    <div class="container">
        <ul class="breadcrumbs not-marked nav">
            <li><a href="/" class="breadcrumbs-link">
                <svg class="svg-icon smart-home-icon" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 223 193.5">
                    <path class="st0" d="M204.5,79.3l-86-76.7c-4-3.5-9.9-3.5-13.9,0l-86,76.7c-2.2,2-3.5,4.8-3.5,7.8v96c0,5.8,4.7,10.4,10.4,10.4 h172.1c5.8,0,10.4-4.7,10.4-10.4v-96C208,84.1,206.7,81.3,204.5,79.3L204.5,79.3z M187.1,172.6H35.9V91.8l75.6-67.4l75.6,67.4 V172.6L187.1,172.6z"/>
                </svg>
            </a></li>
            <li><a href="/agency/realty" class="breadcrumbs-link dark">Недвижимость</a></li>
            <li><a href="#" class="breadcrumbs-link dark">{{ adSeo.pattern_title(advertisement)|e }}</a></li>
        </ul>
        <div class="title-normal title-min-size"><h2>{{ adSeo.pattern_title(advertisement)|e }}</h2></div>
        <div class="row">
            <div class="col-2-3 col-xs-1">
                {% set gallery = adView.getGallery(advertisement) %}
                {% set galleryList = gallery.items ?: [gallery.first] %}
                <div class="swiper-container case-slider-top">
                    <div class="swiper-wrapper">
                        {% for galleryItem in galleryList %}
                            <div class="swiper-slide case-slide">
                                {% set favoriteActiveClass = '' %}
                                {% set favoriteAction = 'add' %}
                                {% if favorite.has('Advertisement', advertisement.Advertisement.id) %}
                                    {% set favoriteActiveClass = ' active' %}
                                    {% set favoriteAction = 'remove' %}
                                {% endif %}
                                {{ html.tag('div', '', {
                                    'class': 'favorites-action star' ~ favoriteActiveClass,
                                    'escape': false,
                                    'data-model': 'Advertisement',
                                    'data-id': advertisement.Advertisement.id,
                                    'data-action': favoriteAction
                                }) }}
                                <img src="{{ galleryItem.src }}" alt="{{ galleryItem.description }}" class="case-slide-image-top">
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="case-slider-thumbs-wrap">
                    <div class="swiper-container case-slider-thumbs">
                        <div class="swiper-wrapper">
                            {% for galleryItem in galleryList %}
                                <div class="swiper-slide">
                                    <img src="{{ galleryItem.src }}" alt="{{ galleryItem.description }}" class="case-slide-image-thumb">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="swiper-button-next swiper-button-circle case-thumbs-next">
                        <svg class="svg-icon right-chevron" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 185.3 185.3">
                            <path class="st0" d="M51.7,185.3c-2.7,0-5.5-1-7.6-3.1c-4.2-4.2-4.2-11,0-15.2l74.4-74.3L44.1,18.3c-4.2-4.2-4.2-11,0-15.2 c4.2-4.2,11-4.2,15.2,0l81.9,81.9c4.2,4.2,4.2,11,0,15.2l-81.9,81.9C57.2,184.3,54.5,185.3,51.7,185.3z"/>
                        </svg>
                    </div>
                    <div class="swiper-button-prev swiper-button-circle case-thumbs-prev">
                        <svg class="svg-icon left-chevron" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 185.3 185.3">
                            <path class="st0" d="M133.6,0c2.7,0,5.5,1,7.6,3.1c4.2,4.2,4.2,11,0,15.2L66.9,92.7l74.4,74.4c4.2,4.2,4.2,11,0,15.2 c-4.2,4.2-11,4.2-15.2,0l-81.9-81.9c-4.2-4.2-4.2-11,0-15.2L126,3.1C128.1,1,130.9,0,133.6,0z"/>
                        </svg>
                    </div>
                </div>
                <div class="case-text-info-block">
                    {{ location.setConfigFormEdit('Location.form_site_view') }}
                    {% if location.hasShowField('Locality') %}
                        <p><span class="left">Населенный пункт</span><span class="right">{{ advertisement.Location.Locality.title }}</span></p>
                    {% endif %}
                    {% if location.hasShowField('Street') %}
                        <p><span class="left">Улица</span><span class="right">{{ advertisement.Location.Street.title }}</span></p>
                    {% endif %}
                    {% if location.hasShowField('HouseNumber') %}
                        <p><span class="left">Номер дома</span><span class="right">{{ advertisement.Location.house_number }}</span></p>
                    {% endif %}
                </div>
                {% if advertisement.Rieltor.id %}
                    <div class="agent-block hidden-xs">
                        <div class="agent-image-wrap">
                            {% if advertisement.Rieltor.image %}
                                <img src="{{ '/'~advertisement.Rieltor.image|trim('/', 'left') }}" class="agent-image" alt=" ">
                            {% endif %}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">{{ advertisement.Rieltor.name }}</div>
                            <a href="tel:{{ user.getPhoneLink(advertisement.Rieltor) }}" class="agent-phone dark">
                                <span class="phone-icon-wrap">
                                    <svg class="svg-icon phone-icon" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 459 459" xml:space="preserve">
                                        <path class="st0" d="M433.5,318.8c-30.6,0-61.2-5.1-91.8-15.3c-7.6-2.5-17.9,0-25.5,5.1l-56.1,56.1 c-71.4-35.7-130.1-96.9-168.3-168.3l56.1-56.1c7.6-7.6,10.2-17.8,5.1-25.5c-7.6-28.1-12.8-58.7-12.8-89.3 c0-15.3-10.2-25.5-25.5-25.5H25.5C10.2,0,0,10.2,0,25.5C0,265.2,193.8,459,433.5,459c15.3,0,25.5-10.2,25.5-25.5v-89.3 C459,329,448.8,318.8,433.5,318.8z"/>
                                    </svg>
                                </span> {{ user.getPhoneLink(advertisement.Rieltor) }}
                            </a>
                            <a href="mailto:{{ advertisement.Rieltor.email }}" class="agent-email dark">{{ advertisement.Rieltor.email }}</a>
                            <a href="#" class="btn btn-transparent btn-callback open-phone-modal">Связаться с агентом</a>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="col-1-3 col-xs-1">
                <div class="case-price-info">
                    <div class="case-id">id {{ advertisement.Advertisement.id }}</div>
                    <div class="case-price-total">Стоимость <b>{{ price.format(advertisement.Advertisement.price) }} ₽</b></div>
                    <div class="case-price-space">Цена кв.м. <b>{{ price.format(advertisement.Advertisement.price_area) }} ₽</b></div>
                </div>
                <div class="mortgage-calc-wrap">
                    <div class="mortgage-title">Рассчитать ипотеку</div>
                    <div class="mortgage-calc" id="mortgage-calc">
                        <label for="case-price-num" class="label-title">Стоимость объекта</label>
                        <input step="5000" min="0" type="number" id="case-price-num" value="{{ advertisement.Advertisement.price }}">
                        <label for="credit-sum" class="label-title">Сумма кредита</label>
                        <input step="5000" min="0" type="number" id="credit-sum" placeholder="Введите сумму">
                        <label for="credit-precent" class="label-title">Процентная ставка (%)</label>
                        <input step="1" min="0" type="number" id="credit-precent" placeholder="Введите ставку в %">
                        <label for="credit-time" class="label-title">Срок кредита (лет)</label>
                        <input step="1" min="0" type="number" id="credit-time" placeholder="Введите цифру">
                        <div class="mortgage-calc-result">
                            <div><span class="left">Сумма переплаты:</span><span class="right"><span id="overpaymentAmount">0</span>₽</span></div>
                            <div><span class="left">Сумма общая:</span><span class="right"><b><span id="totalAmount">0</span>₽</b></span></div>
                            <div><span class="left">Ежемесячный платеж:</span><span class="right"><span id="monthlyPayment">0</span>₽</span></div>
                        </div>
                        <div class="btn-wrap align-center"><a href="#" class="btn btn-transparent btn-mortgage open-mortgage-modal">Оставить заявку на ипотеку</a></div>
                        {{ html.script({0: '/theme/Default/js/mortgage.js', 1: '/agency/js/price_number_format.js'}, {'inline': false}) }}
                        {{ html.scriptStart({'inline': false, 'safe': false}) }}
                            $(document).ready(() => {
                                const mortgageCalc = $('#mortgage-calc');
                                let casePriceNum = mortgageCalc.find('#case-price-num'), //стоимость объекта
                                    creditSum = mortgageCalc.find('#credit-sum'), //cумма кредита
                                    creditPrecent = mortgageCalc.find('#credit-precent'), //Процентная ставка
                                    creditTime = mortgageCalc.find('#credit-time'), //Срок кредита
                                    overpaymentAmountSpan = mortgageCalc.find('#overpaymentAmount'),
                                    totalAmountSpan = mortgageCalc.find('#totalAmount'),
                                    monthlyPaymentSpan = mortgageCalc.find('#monthlyPayment');
                                const updateMortgageOutput = () => {
                                    const mortgage = new Mortgage(casePriceNum.val(), +creditPrecent.val(), +creditTime.val());
                                    mortgage.setPercentageInitialPayment(((casePriceNum.val() - creditSum.val()) / casePriceNum.val()) * 100 );
                                    const setOutput = (selector, value) => selector.text(formatNumber(value, 0));
                                    setOutput(overpaymentAmountSpan, mortgage.overpayment())
                                    setOutput(totalAmountSpan, mortgage.monthlyPayment() * mortgage.creditTerm * 12)
                                    setOutput(monthlyPaymentSpan, mortgage.monthlyPayment())
                                };
                                casePriceNum.on('change', updateMortgageOutput);
                                creditSum.on('change', updateMortgageOutput);
                                creditPrecent.on('change', updateMortgageOutput);
                                creditTime.on('change', updateMortgageOutput);
                                $('.open-mortgage-modal').on('click', e => {
                                    $('#form_case-price-num').val(casePriceNum.val());
                                    $('#form_payment').val(casePriceNum.val() - creditSum.val());
                                    $('#form_credit-precent').val(creditPrecent.val());
                                    $('#form_credit-time').val(creditTime.val());
                                })
                            })
                        {{ html.scriptEnd() }}
                    </div>
                </div>
            </div>
        </div>
        <div class="tabs-block case-tabs-description" data-tab-block="t-case-desc">
            <ul class="nav nav-tabs">
                <li class="tab-link active" data-tab="t-case-desc-1" data-tab-block="t-case-desc">Описание</li>
                <li class="tab-link" data-tab="t-case-desc-2" data-tab-block="t-case-desc">Сведения о недвижимости</li>
                <li class="tab-link" data-tab="t-case-desc-3" data-tab-block="t-case-desc">Смотреть на карте</li>
            </ul>
            <div class="tabs-content-container">
                <div class="tab-content active" data-tab="t-case-desc-1" data-tab-block="t-case-desc">
                    <div class="case-tabs-description-content">
                        <div class="case-tabs-description-title">Описание</div>
                        <div class="case-tab-description-text">{{ adView.getSiteText(advertisement) }}</div>
                    </div>
                </div>
                <div class="tab-content" data-tab="t-case-desc-2" data-tab-block="t-case-desc">
                    <div class="case-tabs-description-content">
                        <div class="case-tabs-description-title">Сведения о недвижимости</div>
                        <table class="case-description-table">
                            {% set complexCategory = _view.loadHelper('ComplexCategories.ComplexCategory') %}
                            {% set viewCategoryParams = complexCategory.getParamAliases(advertisement.CategoryParamValues, 'show_on_main', {}, 'weight') %}
                            {% for values in viewCategoryParams %}
                                {% if values.value %}
                                    <tr>
                                        <td>{{ values.name }}</td>
                                        <td>{{ values.display_value|join(',') }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                </div>
                <div class="tab-content" data-tab="t-case-desc-3" data-tab-block="t-case-desc">
                    <div class="case-tabs-description-content">
                        <input type="hidden" id="latitude" value="{{ adView.getCoordinateSite(advertisement).latitude }}"/>
                        <input type="hidden" id="longitude" value="{{ adView.getCoordinateSite(advertisement).longitude }}"/>
                        <div class="map-contact-wrap" id="map"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% if similarOffers %}
<section class="section-offer" id="offer">
    <div class="container">
        <div class="title-normal title-min-size"><h2>Похожие предложения</h2></div>
        <div class="row row-3">
            {% for item in similarOffers %}
                {% set offerItem = adView.getInfo(item) %}
                <div class="col-1-3 col-xs-1">
                    <a href="{{ html.url(offerItem.url) }}" class="case-item" title="{{ adSeo.pattern_title(item)|e }}">
                        {% set favoriteActiveClass = '' %}
                        {% set favoriteAction = 'add' %}
                        {% if favorite.has('Advertisement', item.Advertisement.id) %}
                            {% set favoriteActiveClass = ' active' %}
                            {% set favoriteAction = 'remove' %}
                        {% endif %}
                        {{ html.tag('div', '', {
                            'class': 'favorites-action star' ~ favoriteActiveClass,
                            'escape': false,
                            'data-model': 'Advertisement',
                            'data-id': item.Advertisement.id,
                            'data-action': favoriteAction
                        }) }}
                        <div class="case-id">id {{ item.Advertisement.id }}</div>
                        <picture class="case-image-wrap">
                            {% set gallery = adView.getGallery(item) %}
                            {% set galleryFirstItem = imageResized.resizeItemPicture(gallery.first, {'width': '379', 'height': '266', 'mode': 'fit', 'paddings': false, 'folder': 'twig_fit_realty_list'}) %}
                            <img src="{{ galleryFirstItem.src }}" class="case-image" alt="{{ galleryFirstItem.description }}">
                        </picture>
                        <div class="case-content">
                            <div class="case-title">{{ item.Advertisement.location_full|e }}</div>
                            <div class="case-price">{{ price.format(item.Advertisement.price) }} ₽</div>
                            <div class="case-text">{{ adView.getSiteText(item)|striptags|slice(0, 50) }}...</div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
